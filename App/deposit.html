<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Pocket Investie - Deposit Funds</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Firebase App (core Firebase SDK) -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
    <!-- Firebase Firestore -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-firestore.js"></script>
    <!-- Firebase Auth -->
    <script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>
    <!-- Paystack Inline JS -->
    <script src="https://js.paystack.co/v1/inline.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background: linear-gradient(135deg, #ff7e5f, #feb47b, #6a11cb, #2575fc);
            background-size: 400% 400%;
            animation: gradientBG 15s ease infinite;
            color: #333;
            min-height: 100vh;
            padding: 20px;
        }
        
        @keyframes gradientBG {
            0% { background-position: 0% 50%; }
            50% { background-position: 100% 50%; }
            100% { background-position: 0% 50%; }
        }
        
        .container {
            max-width: 1400px;
            margin: 0 auto;
        }
        
        /* Header Styles */
        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 20px;
        }
        
        .logo {
            display: flex;
            align-items: center;
        }
        
        .logo h1 {
            font-size: 28px;
            background: linear-gradient(90deg, #6a11cb, #2575fc);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin-left: 10px;
        }
        
        .logo-icon {
            font-size: 32px;
            color: #6a11cb;
        }
        
        .user-info {
            display: flex;
            align-items: center;
        }
        
        .user-avatar {
            width: 45px;
            height: 45px;
            background: linear-gradient(90deg, #6a11cb, #2575fc);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            font-size: 20px;
            margin-right: 15px;
        }
        
        .notification-bell {
            font-size: 24px;
            color: #6a11cb;
            margin: 0 20px;
            cursor: pointer;
            position: relative;
        }
        
        .notification-badge {
            position: absolute;
            top: -5px;
            right: -5px;
            background: #ff4757;
            color: white;
            border-radius: 50%;
            width: 18px;
            height: 18px;
            font-size: 12px;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        /* Navigation */
        nav {
            display: flex;
            justify-content: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 15px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        nav a {
            text-decoration: none;
            color: #2c3e50;
            padding: 12px 25px;
            margin: 0 10px;
            border-radius: 10px;
            transition: all 0.3s ease;
            font-weight: 500;
        }
        
        nav a:hover, nav a.active {
            background: linear-gradient(90deg, rgba(106, 17, 203, 0.1), rgba(37, 117, 252, 0.1));
            color: #6a11cb;
        }
        
        nav a i {
            margin-right: 8px;
        }
        
        /* Page Header */
        .page-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .page-title {
            font-size: 24px;
            color: #2c3e50;
        }
        
        /* Main Content */
        .deposit-content {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-bottom: 20px;
        }
        
        /* Deposit Form */
        .deposit-form {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .form-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #2c3e50;
        }
        
        .form-group input, .form-group select {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid #ddd;
            border-radius: 8px;
            font-size: 16px;
            transition: all 0.3s ease;
        }
        
        .form-group input:focus, .form-group select:focus {
            outline: none;
            border-color: #6a11cb;
            box-shadow: 0 0 0 3px rgba(106, 17, 203, 0.1);
        }
        
        .amount-options {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
            margin-bottom: 20px;
        }
        
        .amount-option {
            padding: 15px;
            border: 2px solid #ddd;
            border-radius: 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .amount-option:hover {
            border-color: #6a11cb;
        }
        
        .amount-option.selected {
            border-color: #6a11cb;
            background: rgba(106, 17, 203, 0.1);
        }
        
        .amount-option .amount {
            font-size: 18px;
            font-weight: 700;
            color: #2c3e50;
        }
        
        .amount-option .bonus {
            font-size: 14px;
            color: #2ecc71;
        }
        
        .btn {
            padding: 12px 25px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
            font-weight: 500;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: all 0.3s ease;
            font-size: 16px;
            width: 100%;
        }
        
        .btn-primary {
            background: linear-gradient(90deg, #6a11cb, #2575fc);
            color: white;
        }
        
        .btn-primary:hover {
            transform: translateY(-3px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        .btn-primary:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
            box-shadow: none;
        }
        
        /* Deposit Info */
        .deposit-info {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .info-title {
            font-size: 20px;
            color: #2c3e50;
            margin-bottom: 20px;
        }
        
        .info-card {
            background: linear-gradient(90deg, rgba(106, 17, 203, 0.1), rgba(37, 117, 252, 0.1));
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 20px;
        }
        
        .info-card h3 {
            color: #6a11cb;
            margin-bottom: 10px;
        }
        
        .info-list {
            list-style: none;
        }
        
        .info-list li {
            padding: 10px 0;
            border-bottom: 1px solid rgba(106, 17, 203, 0.1);
            display: flex;
            align-items: center;
        }
        
        .info-list li:last-child {
            border-bottom: none;
        }
        
        .info-list li i {
            color: #6a11cb;
            margin-right: 10px;
        }
        
        /* Recent Deposits */
        .recent-deposits {
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            padding: 25px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            grid-column: 1 / -1;
        }
        
        .section-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .section-title {
            font-size: 20px;
            color: #2c3e50;
        }
        
        .deposit-item {
            display: flex;
            justify-content: space-between;
            padding: 15px 0;
            border-bottom: 1px solid #f1f2f6;
        }
        
        .deposit-details {
            flex: 1;
        }
        
        .deposit-amount {
            font-weight: 700;
            font-size: 18px;
            color: #2ecc71;
        }
        
        .deposit-date {
            font-size: 14px;
            color: #7f8c8d;
        }
        
        .deposit-status {
            padding: 5px 10px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 500;
        }
        
        .completed {
            background: rgba(46, 204, 113, 0.2);
            color: #2ecc71;
        }
        
        .pending {
            background: rgba(241, 196, 15, 0.2);
            color: #f39c12;
        }
        
        /* Footer */
        footer {
            text-align: center;
            padding: 20px;
            background: rgba(255, 255, 255, 0.95);
            border-radius: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            color: #7f8c8d;
        }
        
        /* Loading States */
        .loading {
            color: #7f8c8d;
            text-align: center;
            padding: 20px;
        }
        
        /* Responsive Design */
        @media (max-width: 1024px) {
            .deposit-content {
                grid-template-columns: 1fr;
            }
        }
        
        @media (max-width: 768px) {
            nav {
                flex-wrap: wrap;
            }
            
            nav a {
                margin-bottom: 10px;
            }
            
            .amount-options {
                grid-template-columns: 1fr;
            }
            
            .user-info {
                flex-direction: column;
                align-items: flex-end;
            }
            
            .user-details {
                margin-top: 10px;
                text-align: right;
            }
        }
        
        /* Toast Notification */
        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #2ecc71;
            color: white;
            padding: 15px 20px;
            border-radius: 8px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: flex;
            align-items: center;
            gap: 10px;
            z-index: 1000;
            transform: translateY(100px);
            opacity: 0;
            transition: all 0.3s ease;
        }
        
        .toast.show {
            transform: translateY(0);
            opacity: 1;
        }
        
        .toast.error {
            background: #ff4757;
        }
        
        /* Modal */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            align-items: center;
            justify-content: center;
        }
        
        .modal-content {
            background: white;
            padding: 30px;
            border-radius: 15px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
        }
        
        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
        }
        
        .modal-title {
            font-size: 20px;
            color: #2c3e50;
        }
        
        .close-modal {
            background: none;
            border: none;
            font-size: 24px;
            cursor: pointer;
            color: #7f8c8d;
        }
        
        .modal-body {
            margin-bottom: 20px;
        }
        
        .modal-footer {
            display: flex;
            justify-content: flex-end;
            gap: 10px;
        }
    </style>
</head>
<body>
    <div class="container">
        <!-- Header -->
        <header>
            <div class="logo">
                <i class="fas fa-piggy-bank logo-icon"></i>
                <h1>Pocket Investie</h1>
            </div>
            <div class="user-info">
                <div class="user-avatar">
                    <i class="fas fa-user"></i>
                </div>
                <div class="user-details">
                    <div id="userName">Loading...</div>
                    <div id="userEmail" style="font-size: 14px; color: #7f8c8d;">Loading...</div>
                </div>
                <div class="notification-bell" id="notificationBell">
                    <i class="fas fa-bell"></i>
                    <span class="notification-badge">3</span>
                </div>
            </div>
        </header>
        
        <!-- Navigation -->
        <nav>
            <a href="dashboard.html"><i class="fas fa-th-large"></i> Dashboard</a>
            <a href="invest.html"><i class="fas fa-chart-line"></i> My Investments</a>
            <a href="deposit.html" class="active"><i class="fas fa-plus-circle"></i> Deposit Funds</a>
            <a href="withdraw.html"><i class="fas fa-money-bill-wave"></i> Withdraw Funds</a>
            <a href="transaction.html"><i class="fas fa-exchange-alt"></i> Transactions</a>
            <a href="profile.html"><i class="fas fa-user-cog"></i> Account Settings</a>
            <a href="#" id="supportLink"><i class="fas fa-headset"></i> Customer Support</a>
            <a href="#" id="logoutBtn"><i class="fas fa-sign-out-alt"></i> Logout</a>
        </nav>
        
        <!-- Page Header -->
        <div class="page-header">
            <h2 class="page-title">Deposit Funds</h2>
        </div>
        
        <!-- Main Content -->
        <div class="deposit-content">
            <!-- Deposit Form -->
            <div class="deposit-form">
                <h3 class="form-title">Add Funds to Your Wallet</h3>
                
                <div class="form-group">
                    <label for="amount">Amount (₦)</label>
                    <input type="number" id="amount" placeholder="Enter amount" min="1000" required>
                </div>
                
                <div class="amount-options">
                    <div class="amount-option" data-amount="5000">
                        <div class="amount">₦5,000</div>
                    </div>
                    <div class="amount-option" data-amount="10000">
                        <div class="amount">₦10,000</div>
                        <div class="bonus">+1% bonus</div>
                    </div>
                    <div class="amount-option" data-amount="20000">
                        <div class="amount">₦20,000</div>
                        <div class="bonus">+2% bonus</div>
                    </div>
                    <div class="amount-option" data-amount="50000">
                        <div class="amount">₦50,000</div>
                        <div class="bonus">+5% bonus</div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label for="paymentMethod">Payment Method</label>
                    <select id="paymentMethod">
                        <option value="card">Debit/Credit Card</option>
                        <option value="bank">Bank Transfer</option>
                        <option value="ussd">USSD</option>
                    </select>
                </div>
                
                <button id="depositBtn" class="btn btn-primary">
                    <i class="fas fa-lock"></i> Proceed to Payment
                </button>
            </div>
            
            <!-- Deposit Information -->
            <div class="deposit-info">
                <h3 class="info-title">Deposit Information</h3>
                
                <div class="info-card">
                    <h3>Current Balance</h3>
                    <div class="balance-amount" id="currentBalance">₦0.00</div>
                </div>
                
                <div class="info-list">
                    <li><i class="fas fa-check-circle"></i> Instant deposits</li>
                    <li><i class="fas fa-check-circle"></i> No hidden fees</li>
                    <li><i class="fas fa-check-circle"></i> Secure payments</li>
                    <li><i class="fas fa-check-circle"></i> 24/7 support</li>
                </div>
                
                <div class="info-card">
                    <h3>Bonuses</h3>
                    <p>Get up to 5% bonus on deposits over ₦10,000. Higher deposits earn higher bonuses!</p>
                </div>
            </div>
            
            <!-- Recent Deposits -->
            <div class="recent-deposits">
                <div class="section-header">
                    <h3 class="section-title">Recent Deposits</h3>
                </div>
                <div id="recentDepositsList">
                    <div class="loading">Loading recent deposits...</div>
                </div>
            </div>
        </div>
        
        <!-- Footer -->
        <footer>
            <p>© 2025 Pocket Investie. All rights reserved.</p>
        </footer>
        
        <!-- Toast Notification -->
        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toastMessage">Operation completed successfully</span>
        </div>
        
        <!-- Payment Modal -->
        <div class="modal" id="paymentModal">
            <div class="modal-content">
                <div class="modal-header">
                    <h3 class="modal-title">Confirm Payment</h3>
                    <button class="close-modal">&times;</button>
                </div>
                <div class="modal-body">
                    <p>You are about to deposit <strong id="confirmAmount">₦0.00</strong> to your Pocket Investie wallet.</p>
                    <p>Click "Confirm" to proceed to payment.</p>
                </div>
                <div class="modal-footer">
                    <button class="btn" id="cancelPayment">Cancel</button>
                    <button class="btn btn-primary" id="confirmPayment">Confirm</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // Firebase configuration (replace with your actual config)
        const firebaseConfig = {
            apiKey: "AIzaSyDQ8AejmnXU8lO1mHdMNoL8G85nmxnYn_A",
            authDomain: "pocket-investie.firebaseapp.com",
            projectId: "pocket-investie",
            storageBucket: "pocket-investie.firebasestorage.app",
            messagingSenderId: "246875262393",
            appId: "1:246875262393:web:f0468ca3f1da95f4b4fa68"
        };
        
        // Initialize Firebase
        firebase.initializeApp(firebaseConfig);
        const db = firebase.firestore();
        const auth = firebase.auth();
        
        // Paystack public key (replace with your actual key)
        const paystackPublicKey = "pk_live_d99488acf1205e97b3cfb64588f262d0d6ca3c9d";
        
        // DOM Elements
        const userNameElement = document.getElementById('userName');
        const userEmailElement = document.getElementById('userEmail');
        const currentBalanceElement = document.getElementById('currentBalance');
        const amountInput = document.getElementById('amount');
        const amountOptions = document.querySelectorAll('.amount-option');
        const depositBtn = document.getElementById('depositBtn');
        const recentDepositsList = document.getElementById('recentDepositsList');
        const toast = document.getElementById('toast');
        const toastMessage = document.getElementById('toastMessage');
        const logoutBtn = document.getElementById('logoutBtn');
        const supportLink = document.getElementById('supportLink');
        const paymentModal = document.getElementById('paymentModal');
        const confirmAmount = document.getElementById('confirmAmount');
        const confirmPayment = document.getElementById('confirmPayment');
        const cancelPayment = document.getElementById('cancelPayment');
        const closeModal = document.querySelector('.close-modal');
        
        // Current user data
        let userId = null;
        let userData = null;
        let currentAmount = 0;
        
        // Check authentication state
        auth.onAuthStateChanged(user => {
            if (user) {
                // User is signed in
                userId = user.uid;
                userNameElement.textContent = user.displayName || 'User';
                userEmailElement.textContent = user.email;
                
                // Fetch user data from Firestore
                fetchUserData(userId);
                fetchRecentDeposits(userId);
            } else {
                // User is signed out, redirect to auth page
                window.location.href = 'auth.html';
            }
        });
        
        // Fetch user data from Firestore
        function fetchUserData(userId) {
            db.collection('users').doc(userId).get()
            .then(doc => {
                if (doc.exists) {
                    userData = doc.data();
                    currentBalanceElement.textContent = `₦${userData.currentBalance?.toLocaleString('en-US') || '0.00'}`;
                } else {
                    console.log("No such document!");
                }
            })
            .catch(error => {
                console.log("Error getting document:", error);
            });
        }
        
        // Fetch recent deposits from Firestore
        function fetchRecentDeposits(userId) {
            db.collection('transactions')
            .where('userId', '==', userId)
            .where('type', '==', 'deposit')
            .orderBy('transactionDate', 'desc')
            .limit(5)
            .get()
            .then(querySnapshot => {
                if (querySnapshot.empty) {
                    recentDepositsList.innerHTML = '<div class="loading">No recent deposits found</div>';
                    return;
                }
                
                let depositsHTML = '';
                querySnapshot.forEach(doc => {
                    const deposit = doc.data();
                    const date = deposit.transactionDate?.toDate() || new Date();
                    
                    depositsHTML += `
                        <div class="deposit-item">
                            <div class="deposit-details">
                                <div class="deposit-amount">+₦${deposit.amount?.toLocaleString('en-US')}</div>
                                <div class="deposit-date">${date.toLocaleString()}</div>
                            </div>
                            <div class="deposit-status ${deposit.status}">${deposit.status}</div>
                        </div>
                    `;
                });
                
                recentDepositsList.innerHTML = depositsHTML;
            })
            .catch(error => {
                console.log("Error getting deposits:", error);
                recentDepositsList.innerHTML = '<div class="loading">Error loading recent deposits</div>';
            });
        }
        
        // Amount option selection
        amountOptions.forEach(option => {
            option.addEventListener('click', () => {
                amountOptions.forEach(opt => opt.classList.remove('selected'));
                option.classList.add('selected');
                
                const amount = option.getAttribute('data-amount');
                amountInput.value = amount;
            });
        });
        
        // Deposit button click handler
        depositBtn.addEventListener('click', () => {
            const amount = parseInt(amountInput.value);
            
            // Validate amount
            if (!amount || amount < 1000) {
                showToast('Please enter a valid amount (minimum ₦1000)', true);
                return;
            }
            
            currentAmount = amount;
            confirmAmount.textContent = `₦${amount.toLocaleString('en-US')}`;
            paymentModal.style.display = 'flex';
        });
        
        // Confirm payment
        confirmPayment.addEventListener('click', () => {
            paymentModal.style.display = 'none';
            initializePayment(currentAmount);
        });
        
        // Cancel payment
        cancelPayment.addEventListener('click', () => {
            paymentModal.style.display = 'none';
        });
        
        // Close modal
        closeModal.addEventListener('click', () => {
            paymentModal.style.display = 'none';
        });
        
        // Initialize Paystack payment
        function initializePayment(amount) {
            // Show processing state
            depositBtn.disabled = true;
            depositBtn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Processing...';
            
            // Create transaction reference
            const ref = 'DEP_' + Date.now() + '_' + Math.random().toString(36).substr(2, 9);
            
            // Create transaction data
            const transactionData = {
                userId: userId,
                type: 'deposit',
                amount: amount,
                currency: 'NGN',
                status: 'pending',
                description: `Deposit via Card`,
                paymentMethod: 'card',
                transactionDate: new Date(),
                referenceId: ref
            };
            
            // Add transaction to Firestore first
            db.collection('transactions').add(transactionData)
            .then(() => {
                // Initialize Paystack payment
                const handler = PaystackPop.setup({
                    key: paystackPublicKey,
                    email: userData.email,
                    amount: amount * 100, // Convert to kobo
                    currency: 'NGN',
                    ref: ref,
                    callback: function(response) {
                        // Payment successful
                        handlePaymentSuccess(ref, response.reference);
                    },
                    onClose: function() {
                        // User closed the payment modal
                        handlePaymentCancellation(ref);
                    }
                });
                
                handler.openIframe();
            })
            .catch(error => {
                console.error("Error creating transaction:", error);
                showToast("Error processing payment. Please try again.", true);
                depositBtn.disabled = false;
                depositBtn.innerHTML = '<i class="fas fa-lock"></i> Proceed to Payment';
            });
        }
        
        // Handle successful payment
        function handlePaymentSuccess(transactionRef, paymentRef) {
            // Update transaction status
            db.collection('transactions')
            .where('referenceId', '==', transactionRef)
            .get()
            .then(querySnapshot => {
                if (!querySnapshot.empty) {
                    const docId = querySnapshot.docs[0].id;
                    
                    db.collection('transactions').doc(docId).update({
                        status: 'completed',
                        processedAt: new Date(),
                        paymentReference: paymentRef
                    });
                    
                    // Update user balance
                    const newBalance = (userData.currentBalance || 0) + currentAmount;
                    
                    db.collection('users').doc(userId).update({
                        currentBalance: newBalance,
                        totalDeposits: (userData.totalDeposits || 0) + currentAmount,
                        lastUpdated: new Date()
                    })
                    .then(() => {
                        // Show success message
                        showToast(`Deposit of ₦${currentAmount.toLocaleString('en-US')} successful!`);
                        
                        // Reset form
                        amountInput.value = '';
                        amountOptions.forEach(opt => opt.classList.remove('selected'));
                        
                        // Update UI
                        currentBalanceElement.textContent = `₦${newBalance.toLocaleString('en-US')}`;
                        
                        // Refresh recent deposits
                        fetchRecentDeposits(userId);
                        
                        // Update local user data
                        userData.currentBalance = newBalance;
                        userData.totalDeposits = (userData.totalDeposits || 0) + currentAmount;
                    })
                    .catch(error => {
                        console.error("Error updating user balance:", error);
                        showToast("Error updating balance. Please contact support.", true);
                    });
                }
            })
            .catch(error => {
                console.error("Error updating transaction:", error);
                showToast("Error updating transaction. Please contact support.", true);
            })
            .finally(() => {
                // Reset button state
                depositBtn.disabled = false;
                depositBtn.innerHTML = '<i class="fas fa-lock"></i> Proceed to Payment';
            });
        }
        
        // Handle payment cancellation
        function handlePaymentCancellation(transactionRef) {
            // Update transaction status to cancelled
            db.collection('transactions')
            .where('referenceId', '==', transactionRef)
            .get()
            .then(querySnapshot => {
                if (!querySnapshot.empty) {
                    const docId = querySnapshot.docs[0].id;
                    
                    db.collection('transactions').doc(docId).update({
                        status: 'cancelled',
                        processedAt: new Date()
                    });
                }
            })
            .catch(error => {
                console.error("Error updating transaction:", error);
            })
            .finally(() => {
                showToast('Payment was cancelled', true);
                depositBtn.disabled = false;
                depositBtn.innerHTML = '<i class="fas fa-lock"></i> Proceed to Payment';
            });
        }
        
        // Show toast notification
        function showToast(message, isError = false) {
            toastMessage.textContent = message;
            
            if (isError) {
                toast.classList.add('error');
                toast.querySelector('i').className = 'fas fa-exclamation-circle';
            } else {
                toast.classList.remove('error');
                toast.querySelector('i').className = 'fas fa-check-circle';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Logout functionality
        logoutBtn.addEventListener('click', (e) => {
            e.preventDefault();
            auth.signOut().then(() => {
                window.location.href = 'auth.html';
            });
        });
        
        // Support link
        supportLink.addEventListener('click', (e) => {
            e.preventDefault();
            alert('Our customer support team is available 24/7. Please email support@pocketinvestie.com or use the live chat feature.');
        });
    </script>
</body>
</html>
